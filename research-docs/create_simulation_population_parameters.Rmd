---
title: "Obtaining population parameters for the simulation study"
output: html_notebook
---

# Introduction

In this R notebook, I select several channels from the pre-processed EEG and EOG channels [TODO: add links]. I then fit the multilevel HMM on these data and obtain the between-subject emission distribution means and transition probabilities. These will be used for the purposes of simulating new data to be used in the study.

## Downloading the data

You can obtain the pre-processed EEG/EOG data from [this](https://drive.google.com/open?id=13w-CC3XWrmtzF_4upfmSqJ16IVS1CmJ8) link. Next, place the file in the same folder as this R notebook. Alternatively, you can download the dataset yourself and pre-process it using the following docker programs: [TODO: add links].

## Download the model

Using the (preprocessed) data, you can run the code below in its entirety to obtain the model, or you can download the model from [this](https://drive.google.com/open?id=1vw2By35eQnHkgBmWnfopK8zKWEesEjRO) link. Next, place the file in the same folder as this R notebook.

# Selecting channels from the raw data

Each EEG/EOG channel (of which there are three), has been decomposed into Gamma, Delta, Theta, Alpha and Beta waves. These measure brain activity at different frequencies and are computed by applying [Fourier transforms](https://mne.tools/stable/generated/mne.time_frequency.psd_multitaper.html?highlight=psd_multitaper#mne.time_frequency.psd_multitaper) to the raw EEG/EOG data. 

The mHMM model requires us to use one or more emission distributions that:

 a. Are multi-modal. The idea being that each distribution is uniquely determined by some latent, underlying state.
 b. That overlap somewhat, but not *too* much. 

At this point, you should install the [tidyverse](https://cran.r-project.org/web/packages/tidyverse/index.html) library. 

```{r}
rm(list=ls())
library(tidyverse)
```

We load the data and apply a logit transformation to the channels. This is done because all values are close to $0$ and not normally distributed. By applying a logit, the data more closely resemble Gaussian distributions. We further subset the data for individuals between the ages of $20$ and $50$. Older subjects exhibit unstable values. All channels are grand-mean centered and scaled.

```{r}
# Load data
ait <- readRDS("EEG_data_final.rds") %>%
  filter(age >= 20 & age < 50) %>%
  # Remove these variables
  select(-patient, -gender, -age) %>%
  # From wide to long --> var == channels, val == value
  gather(var, val, -identifier, -sleep_state, -epoch) %>%
  # Group by person, variable and state
  group_by(identifier, var, sleep_state) %>%
  # Perform logit transformation
  mutate(val = log(val / (1-val))) %>%
  ungroup() %>%
  # Group by person and variable
  group_by(identifier, var) %>%
  # Grand-mean center variables
  mutate(val = ((val - mean(val)) / sd(val))) %>%
  ungroup() #%>%
```

The following three channels are chosen for the analysis.

```{r}
# Select these channels
selected_channels <- c("EOG_min_beta", "EOG_median_theta", "EEG_Fpz_Cz_mean_beta")
```

Subsetting and plotting these variables yields the following plots:

```{r}
# Filter the data
io <- ait %>%
  filter(var %in% selected_channels) %>%
  # Pivot to wide
  pivot_wider(id_cols = c(identifier, epoch, sleep_state), names_from = var, values_from = val) %>%
  # Remove epochs
  select(-epoch)

# Get unique identifiers
# Map to numeric 1-len(identifer))
uid <- unique(as.character(io$identifier))
ids <- 1:length(uid)
names(ids) <- uid
io$id <- unname(ids[as.character(io$identifier)])
io$identifier <- NULL
io <- io[,c(5, 1, 2, 3, 4)]

head(io)
```

```{r}
library(ggplot2)
io %>%
  gather(var, val, -sleep_state, -id) %>%
  ggplot(aes(x=val, fill=sleep_state)) +
    geom_density(alpha = 0.4) +
    facet_wrap(". ~ var", ncol=1)
```

---
title: "Obtaining population parameters for the simulation study"
output: html_notebook
---

# Introduction

In this R notebook, I select several channels from the pre-processed [EEG](https://en.wikipedia.org/wiki/Electroencephalography) and [EOG](https://en.wikipedia.org/wiki/Electrooculography) channels used to detect [sleep states](https://en.wikipedia.org/wiki/Sleep#Non-REM_and_REM_sleep). For the purposes of this study, I use three states: Awake, REM sleep and Non-REM (NREM) sleep. I then fit the multilevel HMM on these data and obtain the between-subject emission distribution means and transition probabilities. These will be used for the purposes of simulating new data to be used in the study.

## Downloading the data

You can obtain the pre-processed EEG/EOG data from [this](https://drive.google.com/open?id=13w-CC3XWrmtzF_4upfmSqJ16IVS1CmJ8) link. Next, place the file in the same folder as this R notebook. Alternatively, you can download the dataset yourself and pre-process it using the following docker programs: [TODO: add links].

## Download the model

Using the (preprocessed) data, you can run the code below in its entirety to obtain the model, or you can download the model from [this](https://drive.google.com/open?id=1vw2By35eQnHkgBmWnfopK8zKWEesEjRO) link. Next, place the file in the same folder as this R notebook.

# Selecting channels from the raw data

Each EEG/EOG channel (of which there are three), has been decomposed into Gamma, Delta, Theta, Alpha and Beta waves. These measure [brain activity](https://en.wikipedia.org/wiki/Neural_oscillation) at different frequencies and are computed by applying [Fourier transforms](https://mne.tools/stable/generated/mne.time_frequency.psd_multitaper.html?highlight=psd_multitaper#mne.time_frequency.psd_multitaper) to the raw EEG/EOG data. 

The mHMM model requires us to use one or more emission distributions that:

 a. Are multi-modal. The idea being that each distribution is uniquely determined by some latent, underlying state.
 b. That overlap somewhat, but not *too* much. 

At this point, you should install the [tidyverse](https://cran.r-project.org/web/packages/tidyverse/index.html) library. 

```{r}
rm(list=ls())
library(tidyverse)
library(sleepsimR)
```

We load the data and apply a logit transformation to the channels. This is done because all values are close to $0$ and not normally distributed. By applying a logit, the data more closely resemble Gaussian distributions. We further subset the data for individuals between the ages of $20$ and $50$. Older subjects exhibit unstable values. All channels are grand-mean centered and scaled.

```{r}
# Load data
ait <- readRDS("EEG_data_final.rds") %>%
  filter(age >= 20 & age < 50) %>%
  # Remove these variables
  select(-patient, -gender, -age) %>%
  # From wide to long --> var == channels, val == value
  gather(var, val, -identifier, -sleep_state, -epoch) %>%
  # Group by person, variable and state
  group_by(identifier, var, sleep_state) %>%
  # Perform logit transformation
  mutate(val = log(val / (1-val))) %>%
  ungroup() %>%
  # Group by person and variable
  group_by(identifier, var) %>%
  # Grand-mean center variables
  mutate(val = ((val - mean(val)) / sd(val))) %>%
  ungroup() #%>%
```

The following three channels are chosen for the analysis.

```{r}
# Select these channels
selected_channels <- c("EOG_min_beta", "EOG_median_theta", "EEG_Fpz_Cz_mean_beta")
```

Subsetting for these variables yields the following:

```{r}
# Filter the data
io <- ait %>%
  filter(var %in% selected_channels) %>%
  # Pivot to wide
  pivot_wider(id_cols = c(identifier, epoch, sleep_state), names_from = var, values_from = val) %>%
  # Remove epochs
  select(-epoch)

# Get unique identifiers
# Map to numeric 1-len(identifer))
uid <- unique(as.character(io$identifier))
ids <- 1:length(uid)
names(ids) <- uid
io$id <- unname(ids[as.character(io$identifier)])
io$identifier <- NULL
io <- io[,c(5, 1, 2, 3, 4)]

head(io)
```

Plotting the variables yields the following distributions

```{r}
library(ggplot2)
io %>%
  gather(var, val, -sleep_state, -id) %>%
  ggplot(aes(x=val, fill=sleep_state)) +
    geom_density(alpha = 0.4) +
    facet_wrap(". ~ var", ncol=3)
```

Plotting the average values for each individual across each state yields:

```{r}
io %>%
  gather(var, val, -sleep_state, -id) %>%
  group_by(id, var, sleep_state) %>%
  summarize(avgch = mean(val)) %>%
  ggplot(aes(x=avgch, fill=sleep_state)) +
    geom_density(alpha=0.4) +
    facet_wrap("var ~ .")
```

These variables are not ideal in terms of their shape and the amount of overlap they exhibit. However, it is rather interesting to see to what extent the model is able to differentiate between them and how close the parameter estimates are to the values in the data.

## Modeling the data

To model the data, we need to supply initial values as well as hyperparameter values. For both of these, we'll use the sample statistics.

```{r}
# Get summary statistics for each dep var
ss <- io %>%
  gather(variable, value, -id, -sleep_state) %>%
  group_by(id, variable, sleep_state) %>%
  summarize(mvar = mean(value)) %>%
  ungroup() %>%
  group_by(variable, sleep_state) %>%
  summarize(mmvar = mean(mvar),
            vvvar = var(mvar))
```

```{r}
print(ss)
```

Next, we define the model properties; the number of hidden states and emission distributions.

```{r}
# Model properties
mprop = list(
  "m" = 3,
  "n_dep" = 3
)
```

We also specify the number of MCMC iterations and how many samples are used as burn-in samples.

```{r}
# Mcmc options
mcmcOpts <- list(
  "J"=2000,
  "burn_in"=1000
)
```

We'll set the start values for each emission distribution to be close to the observed between-subject means.

```{r}
# Starting values
## TPM gamma
start_gamma <- diag(.6, mprop$m)
start_gamma[lower.tri(start_gamma) | upper.tri(start_gamma)] <- .2
# For the 4 continuous emission distributions
start_EM <- list(
  # Gamma
  start_gamma,
  #EEG_Fpz_Cz_max_gamma
  matrix(c( -.38, 0.1,
              0, 0.1,
             1.13, 0.1),
         nrow=mprop$m,
         ncol=2,
         byrow = TRUE),
  # EEG_ Pz_Oz_var_beta
  matrix(c( .5, .1,
           -.6, .1,
           .4, .1),
         nrow=mprop$m,
         ncol=2,
         byrow = TRUE),
  # EEG_ Pz_Oz_var_beta
  matrix(c( 1, .1,
            -.9, .1,
            -.1, .1),
         nrow=mprop$m,
         ncol=2,
         byrow = TRUE)
)
```

Similarly, we set the hyperparameters for the between-subject means to be close to the observed means. NB: Ask E. about uninformative prior for these.

```{r}
# Set hyper-prior values
hyper_priors <- list(
  # Hyperprior on intercepts of dependent variables
  emiss_mu0 = list(
    # Depvar 1
    matrix(c(-.38, 0, 1.1), nrow=1, ncol=mprop$m),
    # Depvar 2
    matrix(c(.46, -.6, .46), nrow=1, ncol=mprop$m),
    # Depvar 3
    matrix(c(1, -.9, -.1), nrow=1, ncol=mprop$m)
  ),
  # Hyperprior on the number of subjects in each state
  # Hypothetical subjects --> c(1,1,1)
  emiss_K0 = list(1,1,1),
  # Degrees of freedom on the emission dist. means
  # Hypothetical degrees of freedom
  emiss_nu = list(1,1,1),
  # Variances between subjects
  # Prior on hyperparameter between-subject variance
  # Hypothetical variances between hypothetical subjects
  emiss_V = list(
    # Depvar1
    c(1,1,1),
    # Depvar2
    c(1,1,1),
    # Depvar3
    c(1,1,1)
  ),
  # shape values. Fixed variances of normal emission distributions
  # SUbject-fixed normal emission distribution shape/scale parameters
  # This is a regular inverse gamma
  emiss_a0 = list(
    # Depvar1
    c(.01,.01,.01),
    # Depvar2
    c(.01,.01,.01),
    # Depvar3
    c(.01,.01,.01)
  ),
  # Hyperprior on scale values of inverse gamma
  emiss_b0 = list(
    # Depvar1
    c(.01,.01,.01),
    # Depvar2
    c(.01,.01,.01),
    # Depvar3
    c(.01,.01,.01)
  )
)
```

We can now run the model.

```{r, eval=FALSE}
# Set seed
set.seed(4459)
# Run model
mod <- mHMMbayes::mHMM_cont(as.matrix(io),
                            gen=mprop,
                            start_val=start_EM,
                            mcmc = mcmcOpts,
                            emiss_hyp_prior = hyper_priors)
```

If you have downloaded the model, load it from disk.

```{r}
mod <- readRDS("sleepmod.rds")
```

## Inspecting the parameters

The `sleepsimR` R library contains S3 classes that are compatible with the `mHMM_cont` class returned by `mHMMbayes::mHMM_cont`. 

Plotting the between-subject emission distributions yields the following:

```{r}
gt <- ss$mmvar[1:3]
plot_posterior_means(mod, var=1, ground_truth = gt) +
  ggtitle("Between-subject means for EEG_Fpz_Cz_mean_beta") 
```

```{r}
gt <- ss$mmvar[4:6]
plot_posterior_means(mod, var=2, ground_truth = gt) +
  ggtitle("Between-subject means for EOG_median_theta") 
```

```{r}
gt <- ss$mmvar[7:9]
plot_posterior_means(mod, var=3, ground_truth = gt) +
  ggtitle("Between-subject means for EOG_min_beta") 
```

The above plots indicate that the second state (NREM-sleep) is most difficult to estimate. In all three variables, the mean observed in the sample is under-estimated severely by the algorithm. Nonetheless, the means of the other two states are reasonably well estimated, with the mean of the 'Awake' state being estimated best.

This result makes sense if you look at the emission distributions. We selected two variables that separated the states 'Awake' and 'REM' reasonably well. 

### The transition probability matrix

The between-subject TPM looks as follows:

```{r}
# Retrieve MAP estimates
get_subject_tpm(mod)
```
